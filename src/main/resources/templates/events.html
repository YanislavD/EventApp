<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–°—ä–±–∏—Ç–∏—è ‚Äì EventApp</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
</head>
<body class="landing">
<header class="landing-header">
    <div class="container topbar">
        <a class="brand" th:href="@{/}">EventApp</a>
        <nav class="nav">
            <a class="nav-link" th:href="@{/home}">–ú–æ–∏—Ç–µ</a>
            <a class="nav-link" th:href="@{/admin/categories}" sec:authorize="hasRole('ADMIN')">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a>
            <a class="nav-link" th:href="@{/admin/users}" sec:authorize="hasRole('ADMIN')">–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏</a>
            <a class="nav-link" th:href="@{/logout}">–ò–∑—Ö–æ–¥</a>
            <button id="themeToggle" class="icon-btn" aria-label="–ü—Ä–µ–≤–∫–ª—é—á–∏ —Ç–µ–º–∞">üåì</button>
        </nav>
    </div>
</header>

<main>
    <section class="hero slim-hero">
        <div class="container hero-inner">
            <h1 class="hero-title">–°—ä–±–∏—Ç–∏—è</h1>
            <p class="hero-subtitle">–ò–∑–±–µ—Ä–∏ —Å—ä–±–∏—Ç–∏–µ –∏ —Å–µ –∑–∞–ø–∏—à–∏</p>
        </div>
        <div class="hero-bg"></div>
    </section>

    <section class="surface-section">
        <div class="container events-container">
        <div class="page-alerts"
             th:if="${param.created} != null or ${param.deleted} != null or ${param.joined} != null or ${param.already} != null or ${param.missing} != null or ${param.error} != null">
            <div class="alert alert-success" th:if="${param.created}">
                <strong>–£—Å–ø–µ—Ö!</strong> –°—ä–±–∏—Ç–∏–µ—Ç–æ –±–µ—à–µ —Å—ä–∑–¥–∞–¥–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ –∏ –≤–µ—á–µ –µ –≤–∏–¥–∏–º–æ –∑–∞ –æ—Å—Ç–∞–Ω–∞–ª–∏—Ç–µ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏.
            </div>

            <div class="alert alert-success" th:if="${param.deleted}">
                <strong>–£—Å–ø–µ—Ö!</strong> –°—ä–±–∏—Ç–∏–µ—Ç–æ –±–µ—à–µ –∏–∑—Ç—Ä–∏—Ç–æ —É—Å–ø–µ—à–Ω–æ.
            </div>

            <div class="alert alert-success" th:if="${param.joined}">
                <strong>–ó–∞–ø–∏—Å–∞–Ω!</strong> –£—Å–ø–µ—à–Ω–æ —Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞ –∑–∞ —Å—ä–±–∏—Ç–∏–µ—Ç–æ.
            </div>

            <div class="alert alert-info" th:if="${param.already}">
                <strong>–í–µ—á–µ —Å–∏ –∑–∞–ø–∏—Å–∞–Ω.</strong> –ú–æ–∂–µ—à –¥–∞ –Ω–∞–º–µ—Ä–∏—à —Å—ä–±–∏—Ç–∏–µ—Ç–æ –≤ —Ç–∞–±–ª–æ—Ç–æ —Å–∏.
            </div>

            <div class="alert alert-error" th:if="${param.missing}">
                <strong>–û–ø–∞!</strong> –ò–∑–≥–ª–µ–∂–¥–∞ —Å—ä–±–∏—Ç–∏–µ—Ç–æ, –∫–æ–µ—Ç–æ –∏–∑–±—Ä–∞, –≤–µ—á–µ –Ω–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞.
            </div>

            <div class="alert alert-error" th:if="${param.error}">
                <strong>–ù–µ —É—Å–ø—è.</strong>
                <span th:switch="${param.error[0]}">
                    <span th:case="'own'">–ù–µ –º–æ–∂–µ—à –¥–∞ —Å–µ –∑–∞–ø–∏—à–µ—à –∑–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–æ —Å—ä–±–∏—Ç–∏–µ.</span>
                    <span th:case="'full'">–ù—è–º–∞ —Å–≤–æ–±–æ–¥–Ω–∏ –º–µ—Å—Ç–∞ –∑–∞ —Ç–æ–≤–∞ —Å—ä–±–∏—Ç–∏–µ.</span>
                    <span th:case="'unauthorized'">–ù—è–º–∞—à –ø—Ä–∞–≤–æ –¥–∞ –∏–∑—Ç—Ä–∏–µ—à —Ç–æ–≤–∞ —Å—ä–±–∏—Ç–∏–µ.</span>
                    <span th:case="'notFound'">–°—ä–±–∏—Ç–∏–µ—Ç–æ –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–æ.</span>
                    <span th:case="*">–í—ä–∑–Ω–∏–∫–Ω–∞ –Ω–µ–æ—á–∞–∫–≤–∞–Ω–æ –∑–∞—Ç—Ä—É–¥–Ω–µ–Ω–∏–µ. –û–ø–∏—Ç–∞–π –æ—Ç–Ω–æ–≤–æ.</span>
                </span>
            </div>
        </div>

        <div class="card form-card events-panel">
            <div class="panel-header">
                <div>
                    <h2 class="panel-title">–í—Å–∏—á–∫–∏ —Å—ä–±–∏—Ç–∏—è</h2>
                    <p class="panel-subtitle">–†–∞–∑–≥–ª–µ–¥–∞–π –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ç–∞ –Ω–∞ –æ–±—â–Ω–æ—Å—Ç—Ç–∞ –∏ —Å–µ –≤–∫–ª—é—á–∏ —Å–∞–º–æ —Å –µ–¥–∏–Ω –∫–ª–∏–∫.</p>
                </div>
                <div class="panel-actions">
                    <a class="btn btn-primary" th:href="@{/events/create}">–°—ä–∑–¥–∞–π —Å—ä–±–∏—Ç–∏–µ</a>
                </div>
            </div>

            <form class="panel-filters" method="get">
                <div class="filter-group">
                    <label for="sort">–°–æ—Ä—Ç–∏—Ä–∞–π –ø–æ</label>
                    <select id="sort" name="sort">
                        <option value="startAsc" th:selected="${selectedSort == null || selectedSort == 'startAsc'}">–î–∞—Ç–∞ (–Ω–∞–π-—Å–∫–æ—Ä–æ)</option>
                        <option value="startDesc" th:selected="${selectedSort == 'startDesc'}">–î–∞—Ç–∞ (–Ω–∞–π-–∫—ä—Å–Ω–æ)</option>
                        <option value="categoryAsc" th:selected="${selectedSort == 'categoryAsc'}">–ö–∞—Ç–µ–≥–æ—Ä–∏—è (A-Z)</option>
                        <option value="categoryDesc" th:selected="${selectedSort == 'categoryDesc'}">–ö–∞—Ç–µ–≥–æ—Ä–∏—è (Z-A)</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select id="category" name="category">
                        <option value="" th:selected="${selectedCategory == null}">–í—Å–∏—á–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                        <option th:each="category : ${categories}"
                                th:value="${category.id}"
                                th:text="${category.name}"
                                th:selected="${selectedCategory != null and selectedCategory.equals(category.id)}"></option>
                    </select>
                </div>

                <div class="filter-actions">
                    <button type="submit" class="btn btn-secondary">–ü—Ä–∏–ª–æ–∂–∏</button>
                    <a class="link-reset" th:if="${selectedCategory != null or (selectedSort != null and selectedSort != 'startAsc')}" th:href="@{/events}">–ò–∑—á–∏—Å—Ç–∏</a>
                </div>
            </form>

            <div class="panel-divider"></div>

            <div class="events-empty" th:if="${#lists.isEmpty(events)}">
                <div class="events-empty-content">
                    <h3>–ù—è–º–∞ –Ω–∞–ª–∏—á–Ω–∏ —Å—ä–±–∏—Ç–∏—è</h3>
                    <p>–í—Å–µ –æ—â–µ –Ω–∏–∫–æ–π –Ω–µ –µ –æ—Ä–≥–∞–Ω–∏–∑–∏—Ä–∞–ª —Å—ä–±–∏—Ç–∏–µ. –ë—ä–¥–∏ –ø—ä—Ä–≤–∏—è—Ç –∏ —Å—ä–∑–¥–∞–π –Ω–æ–≤–æ –ø—Ä–µ–∂–∏–≤—è–≤–∞–Ω–µ.</p>
                    <a class="btn btn-primary" th:href="@{/events/create}">–°—ä–∑–¥–∞–π –ø—ä—Ä–≤–æ—Ç–æ —Å—ä–±–∏—Ç–∏–µ</a>
                </div>
            </div>

            <div class="events-grid" th:if="${!#lists.isEmpty(events)}">
                <article class="feature-card event-card" th:each="event : ${events}">
                    <div class="event-card-header">
                        <div>
                            <h3 th:text="${event.name}">–ò–º–µ –Ω–∞ —Å—ä–±–∏—Ç–∏–µ</h3>
                            <p class="event-card-subtitle"
                               th:text="${!#strings.isEmpty(event.creatorName) ? '–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä: ' + event.creatorName : '–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}">–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</p>
                        </div>
                        <span class="badge badge-neutral" th:if="${!#strings.isEmpty(event.categoryName)}" th:text="${event.categoryName}">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                    </div>

                    <p class="event-card-description" th:text="${event.description}">–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å—ä–±–∏—Ç–∏–µ—Ç–æ</p>

                    <div class="event-card-meta">
                        <span>
                            <strong>–ù–∞—á–∞–ª–æ:</strong>
                            <span th:text="${event.startTime != null ? #temporals.format(event.startTime, 'dd.MM.yyyy HH:mm') : '–î–∞—Ç–∞ TBA'}">–î–∞—Ç–∞</span>
                        </span>
                        <span th:if="${event.endTime != null}">
                            <strong>–ö—Ä–∞–π:</strong>
                            <span th:text="${#temporals.format(event.endTime, 'dd.MM.yyyy HH:mm')}">–ö—Ä–∞–π</span>
                        </span>
                        <span th:if="${event.capacity != null}">
                            <strong>–°–≤–æ–±–æ–¥–Ω–∏ –º–µ—Å—Ç–∞:</strong>
                            <span th:text="${event.remainingCapacity > 0 ? event.remainingCapacity : 0}">0</span>
                        </span>
                        <span th:if="${event.capacity != null}">
                            <strong>–ó–∞–ø–∏—Å–∞–Ω–∏:</strong>
                            <span th:text="${event.registeredCount}">0</span>
                        </span>
                        <span th:if="${event.capacity == null}">
                            <strong>–°–≤–æ–±–æ–¥–Ω–∏ –º–µ—Å—Ç–∞:</strong>
                            <span>–ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω</span>
                        </span>
                    </div>

                    <div class="event-card-footer">
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <form th:if="${event.subscribed}" th:action="@{'/events/' + ${event.id} + '/unsubscribe'}" method="post" style="display: inline;">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="btn btn-secondary" style="font-size: 0.9em; padding: 8px 16px;">–û—Ç–ø–∏—à–∏ —Å–µ</button>
                                </form>
                                <span class="badge badge-neutral" th:if="${event.full && !event.subscribed}">–°—ä–±–∏—Ç–∏–µ—Ç–æ –µ –∑–∞–ø—ä–ª–Ω–µ–Ω–æ</span>
                                <form th:if="${!event.subscribed && !event.full}" th:action="@{'/events/' + ${event.id} + '/subscribe'}" method="post" style="display: inline;">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="btn btn-primary">–ó–∞–ø–∏—à–∏ —Å–µ</button>
                                </form>
                            </div>
                            <form th:if="${(event.creatorId != null and user != null and event.creatorId.equals(user.id)) or (user != null and user.role.name() == 'ADMIN')}" 
                                  th:action="@{/events/{eventId}/delete(eventId=${event.id}, redirect='events')}" 
                                  method="post" 
                                  style="display: inline;">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <button type="submit" class="btn" style="font-size: 0.85em; padding: 6px 12px; background: #dc3545; color: #fff; border: none; cursor: pointer;" onclick="return confirm('–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏, —á–µ –∏—Å–∫–∞—à –¥–∞ –∏–∑—Ç—Ä–∏–µ—à —Ç–æ–≤–∞ —Å—ä–±–∏—Ç–∏–µ? –¢–æ–≤–∞ –¥–µ–π—Å—Ç–≤–∏–µ –µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.');">
                                    –ò–∑—Ç—Ä–∏–π
                                </button>
                            </form>
                        </div>
                    </div>
                </article>
            </div>
        </div>
    </div>
    </section>
</main>

<th:block th:replace="~{fragments/footer :: siteFooter}"></th:block>

<script>
    (function theme(){
        const btn = document.getElementById('themeToggle');
        if(!btn) return;
        const key = 'eventapp-theme';
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const saved = localStorage.getItem(key);
        const apply = (mode) => {
            document.documentElement.dataset.theme = mode;
            localStorage.setItem(key, mode);
        };
        apply(saved || (prefersDark ? 'dark' : 'light'));
        btn.addEventListener('click', () => apply(document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark'));
    })();
</script>
</body>
</html>


