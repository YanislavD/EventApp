<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Управление на потребители – EventApp</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <link rel="stylesheet" th:href="@{/css/admin.css}" />
    <link rel="stylesheet" th:href="@{/css/forms.css}" />
</head>
<body class="landing">
<header class="landing-header">
    <div class="container topbar">
        <a class="brand" th:href="@{/}">EventApp</a>
        <nav class="nav">
            <a class="nav-link" th:href="@{/home}">Табло</a>
            <a class="nav-link" th:href="@{/events}">Събития</a>
            <a class="nav-link" th:href="@{/events/new}">Ново събитие</a>
            <a class="nav-link" sec:authorize="hasRole('ADMIN')" th:href="@{/admin/categories}">Категории</a>
            <a class="nav-link" sec:authorize="hasRole('ADMIN')" th:href="@{/admin/users}">Потребители</a>
            <a class="nav-link" th:href="@{/logout}">Изход</a>
        </nav>
    </div>
</header>

<main>
    <section class="hero slim-hero">
        <div class="container hero-inner">
            <h1 class="hero-title">Управление на потребители</h1>
            <p class="hero-subtitle">Преглеждай и управлявай ролите на регистрираните потребители в системата.</p>
        </div>
        <div class="hero-bg"></div>
    </section>

    <div class="container">
        <div class="tips-section">
            <span class="tips-icon-small">⚙️</span>
            <div class="tips-content-small">
                <div class="tips-title-small">Информация за управлението</div>
                <div class="tips-text-small">
                    Промяната на ролята на потребител веднага променя правата му в системата. Ако променяш собствената си роля, ще бъдеш изведен от системата и ще трябва да влезеш отново.
                </div>
            </div>
        </div>

        <div class="card" th:if="${successMessage}">
            <strong>Готово!</strong> <span th:text="${successMessage}">Ролята беше променена успешно.</span>
        </div>

        <div class="card" th:if="${errorMessage}">
            <strong>Грешка:</strong> <span th:text="${errorMessage}">Действието не беше изпълнено.</span>
        </div>

        <div class="card" th:if="${param.error == 'alreadyHasRole'}">
            <strong>Грешка:</strong> Потребителят вече има тази роля.
        </div>

        <div class="card" th:if="${param.error == 'invalidRole'}">
            <strong>Грешка:</strong> Невалидна роля.
        </div>

        <div class="card" th:if="${param.error == 'notFound'}">
            <strong>Грешка:</strong> Потребителят не е намерен.
        </div>

        <div class="card">
            <h2 class="mt-0">Всички потребители</h2>
            <div th:if="${#lists.isEmpty(users)}">
                <p>Все още няма регистрирани потребители.</p>
            </div>
            <div class="users-grid" th:if="${!#lists.isEmpty(users)}">
                <article class="feature-card" th:each="user : ${users}">
                    <div class="user-card">
                        <div class="user-info-section">
                            <h3 class="user-title" th:text="${user.username}">Потребителско име</h3>
                            <div class="meta meta-margin-top">
                                <div class="meta-item-margin">
                                    <strong>Email:</strong> 
                                    <span th:text="${user.email}">email@example.com</span>
                                </div>
                                <div th:if="${user.firstName != null || user.lastName != null}" class="meta-item-margin">
                                    <strong>Име:</strong>
                                    <span th:text="${(user.firstName != null ? user.firstName : '') + (user.lastName != null ? ' ' + user.lastName : '')}">-</span>
                                </div>
                                <div class="meta-item-margin">
                                    <strong>Текуща роля:</strong> 
                                    <span class="role-badge" 
                                          th:classappend="${user.role.name() == 'ADMIN'} ? 'role-badge-admin' : 'role-badge-user'"
                                          th:text="${user.role.name()}">
                                        USER
                                    </span>
                                </div>
                                <div class="meta-small">
                                    Регистриран: <span th:text="${#temporals.format(user.createdOn, 'dd.MM.yyyy HH:mm')}">...</span>
                                </div>
                            </div>
                        </div>
                        <div class="user-actions-section">
                            <form th:action="@{/admin/users/{id}/role(id=${user.id})}" 
                                  method="post"
                                  class="role-form">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <div>
                                    <label th:for="'role-' + ${user.id}" class="role-label">
                                        Промени роля:
                                    </label>
                                    <select th:id="'role-' + ${user.id}"
                                            name="role" 
                                            class="role-select">
                                        <option th:each="role : ${roles}" 
                                                th:value="${role.name()}" 
                                                th:text="${role.name()}"
                                                th:selected="${user.role == role}">
                                            USER
                                        </option>
                                    </select>
                                </div>
                                <button type="submit" 
                                        class="btn btn-primary role-submit-btn">
                                    Промени роля
                                </button>
                            </form>
                            <form th:action="@{/admin/users/{id}/delete(id=${user.id})}"
                                  method="post"
                                  class="role-form role-form-margin">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <button type="submit"
                                        class="btn btn-secondary delete-user-btn">
                                    Изтрий потребител
                                </button>
                            </form>
                        </div>
                    </div>
                </article>
            </div>
        </div>
    </div>
</main>

<th:block th:replace="~{fragments/footer :: siteFooter}"></th:block>

</body>
</html>

