<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Управление на потребители – EventApp</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <style>
        .users-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }
        @media (min-width: 640px) {
            .users-grid {
                grid-template-columns: repeat(auto-fill, minmax(480px, 1fr));
            }
        }
        .user-card {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            flex-wrap: wrap;
        }
        .user-info-section {
            flex: 1;
            min-width: 200px;
        }
        .user-actions-section {
            min-width: 220px;
            max-width: 280px;
            flex-shrink: 0;
        }
        @media (max-width: 639px) {
            .user-actions-section {
                width: 100%;
                max-width: 100%;
            }
        }
        .role-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .role-select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            font-size: 0.9em;
        }
        .role-select:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(43, 214, 123, 0.18);
        }
    </style>
</head>
<body class="landing">
<header class="landing-header">
    <div class="container topbar">
        <a class="brand" th:href="@{/}">EventApp</a>
        <nav class="nav">
            <a class="nav-link" th:href="@{/home}">Табло</a>
            <a class="nav-link" th:href="@{/events}">Събития</a>
            <a class="nav-link" th:href="@{/events/new}">Ново събитие</a>
            <a class="nav-link" sec:authorize="hasRole('ADMIN')" th:href="@{/admin/categories}">Категории</a>
            <a class="nav-link" sec:authorize="hasRole('ADMIN')" th:href="@{/admin/users}">Потребители</a>
            <a class="nav-link" th:href="@{/logout}">Изход</a>
        </nav>
    </div>
</header>

<main>
    <section class="hero slim-hero">
        <div class="container hero-inner">
            <h1 class="hero-title">Управление на потребители</h1>
            <p class="hero-subtitle">Преглеждай и управлявай ролите на регистрираните потребители в системата.</p>
        </div>
        <div class="hero-bg"></div>
    </section>

    <div class="container">
        <div style="background: linear-gradient(135deg, rgba(79, 70, 229, 0.05) 0%, rgba(79, 70, 229, 0.02) 100%); border: 1px solid rgba(79, 70, 229, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 24px; display: flex; align-items: flex-start; gap: 12px;">
            <span style="font-size: 24px; flex-shrink: 0;">⚙️</span>
            <div style="flex: 1;">
                <div style="font-weight: 700; font-size: 14px; margin-bottom: 6px; color: #4f46e5;">Информация за управлението</div>
                <div style="color: var(--muted); font-size: 13px; line-height: 1.6;">
                    Промяната на ролята на потребител веднага променя правата му в системата. Ако променяш собствената си роля, ще бъдеш изведен от системата и ще трябва да влезеш отново.
                </div>
            </div>
        </div>

        <div class="card" th:if="${successMessage}">
            <strong>Готово!</strong> <span th:text="${successMessage}">Ролята беше променена успешно.</span>
        </div>

        <div class="card" th:if="${errorMessage}">
            <strong>Грешка:</strong> <span th:text="${errorMessage}">Действието не беше изпълнено.</span>
        </div>

        <div class="card" th:if="${param.error == 'alreadyHasRole'}">
            <strong>Грешка:</strong> Потребителят вече има тази роля.
        </div>

        <div class="card" th:if="${param.error == 'invalidRole'}">
            <strong>Грешка:</strong> Невалидна роля.
        </div>

        <div class="card" th:if="${param.error == 'notFound'}">
            <strong>Грешка:</strong> Потребителят не е намерен.
        </div>

        <div class="card">
            <h2 class="mt-0">Всички потребители</h2>
            <div th:if="${#lists.isEmpty(users)}">
                <p>Все още няма регистрирани потребители.</p>
            </div>
            <div class="users-grid" th:if="${!#lists.isEmpty(users)}">
                <article class="feature-card" th:each="user : ${users}">
                    <div class="user-card">
                        <div class="user-info-section">
                            <h3 style="margin: 0 0 12px 0;" th:text="${user.username}">Потребителско име</h3>
                            <div class="meta" style="margin-top: 0;">
                                <div style="margin-bottom: 10px;">
                                    <strong>Email:</strong> 
                                    <span th:text="${user.email}">email@example.com</span>
                                </div>
                                <div th:if="${user.firstName != null || user.lastName != null}" style="margin-bottom: 10px;">
                                    <strong>Име:</strong>
                                    <span th:text="${(user.firstName != null ? user.firstName : '') + (user.lastName != null ? ' ' + user.lastName : '')}">-</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>Текуща роля:</strong> 
                                    <span class="badge" 
                                          style="display: inline-block; padding: 4px 10px; border-radius: 6px; margin-left: 8px; font-size: 0.85em; font-weight: 600;"
                                          th:styleappend="${user.role.name() == 'ADMIN'} ? 'background: var(--brand); color: #fff;' : 'background: var(--border); color: var(--text);'"
                                          th:text="${user.role.name()}">
                                        USER
                                    </span>
                                </div>
                                <div style="font-size: 0.875em; color: var(--muted);">
                                    Регистриран: <span th:text="${#temporals.format(user.createdOn, 'dd.MM.yyyy HH:mm')}">...</span>
                                </div>
                            </div>
                        </div>
                        <div class="user-actions-section">
                            <form th:action="@{/admin/users/{id}/role(id=${user.id})}" 
                                  method="post"
                                  class="role-form">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <div>
                                    <label th:for="'role-' + ${user.id}" style="display: block; margin-bottom: 6px; font-size: 0.875em; font-weight: 600; color: var(--text);">
                                        Промени роля:
                                    </label>
                                    <select th:id="'role-' + ${user.id}"
                                            name="role" 
                                            class="role-select">
                                        <option th:each="role : ${roles}" 
                                                th:value="${role.name()}" 
                                                th:text="${role.name()}"
                                                th:selected="${user.role == role}">
                                            USER
                                        </option>
                                    </select>
                                </div>
                                <button type="submit" 
                                        class="btn btn-primary"
                                        style="width: 100%; padding: 10px 16px; font-size: 0.9em; white-space: nowrap;">
                                    Промени роля
                                </button>
                            </form>
                            <form th:action="@{/admin/users/{id}/delete(id=${user.id})}"
                                  method="post"
                                  class="role-form"
                                  style="margin-top: 8px;">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <button type="submit"
                                        class="btn btn-secondary"
                                        style="width: 100%; padding: 10px 16px; font-size: 0.9em; background: #dc2626; color: #fff; border: none;"
                                        >
                                    Изтрий потребител
                                </button>
                            </form>
                        </div>
                    </div>
                </article>
            </div>
        </div>
    </div>
</main>

<th:block th:replace="~{fragments/footer :: siteFooter}"></th:block>

</body>
</html>

