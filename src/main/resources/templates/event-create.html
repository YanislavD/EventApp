<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–°—ä–∑–¥–∞–π —Å—ä–±–∏—Ç–∏–µ ‚Äì EventApp</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <link rel="stylesheet" th:href="@{/css/forms.css}" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="landing">
<header class="landing-header">
    <div class="container topbar">
        <a class="brand" th:href="@{/home}">EventApp</a>
        <nav class="nav">
            <a class="nav-link" th:href="@{/home}">–¢–∞–±–ª–æ</a>
            <a class="nav-link" th:href="@{/events}">–í—Å–∏—á–∫–∏ —Å—ä–±–∏—Ç–∏—è</a>
            <a class="nav-link" th:href="@{/admin/categories}" sec:authorize="hasRole('ADMIN')">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a>
            <a class="nav-link" th:href="@{/admin/users}" sec:authorize="hasRole('ADMIN')">–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏</a>
            <a class="nav-link" th:href="@{/logout}">–ò–∑—Ö–æ–¥</a>
        </nav>
    </div>
</header>

<main>
    <section class="hero slim-hero">
        <div class="container hero-inner">
            <h1 class="hero-title">–î–æ–±–∞–≤–∏ –Ω–æ–≤–æ —Å—ä–±–∏—Ç–∏–µ</h1>
            <p class="hero-subtitle">–ü–æ–ø—ä–ª–Ω–∏ –¥–µ—Ç–∞–π–ª–∏—Ç–µ –∏ –ø—É–±–ª–∏–∫—É–≤–∞–π —Å–≤–æ–µ—Ç–æ —Å—ä–±–∏—Ç–∏–µ.</p>
        </div>
        <div class="hero-bg"></div>
    </section>

    <div class="container container-max-width">
        <div class="create-form-layout">
            <div class="card form-card form-card-min-width">
                <div class="form-headline form-headline-large">
                    <span class="form-badge">üéüÔ∏è –°—ä–∑–¥–∞–π —Å—ä–±–∏—Ç–∏–µ</span>
                    <h2 class="form-title">–ü–æ–¥–≥–æ—Ç–≤–∏ –¥–µ—Ç–∞–π–ª–∏—Ç–µ</h2>
                    <p class="form-subtitle-text">–û–ø–∏—à–∏ –∫–ª—é—á–æ–≤–∞—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –∑–∞ –¥–∞ –∏–∑–≥–ª–µ–∂–¥–∞ —Ç–≤–æ–µ—Ç–æ —Å—ä–±–∏—Ç–∏–µ –ø—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–Ω–æ –∏ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª–Ω–æ.</p>
                </div>

                <form class="form" th:action="@{/events}" th:object="${eventCreateRequest}" method="post">
                    <div class="form-sections">
                        <div>
                            <h3 class="form-section-title">
                                <span>üìù</span>
                                <span>–û—Å–Ω–æ–≤–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span>
                            </h3>
                            <div class="form-grid-2">
                                <div class="field field-full-width">
                                    <div class="field-header">
                                        <label for="name">–ò–º–µ –Ω–∞ —Å—ä–±–∏—Ç–∏–µ—Ç–æ</label>
                                        <span class="badge-error" th:if="${#fields.hasErrors('name')}" th:errors="*{name}">–í—ä–≤–µ–¥–∏ –∏–º–µ</span>
                                    </div>
                                    <input id="name" th:field="*{name}" placeholder="–ü—Ä–∏–º–µ—Ä: –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ–Ω —Ñ–æ—Ä—É–º 2025" th:classappend="${#fields.hasErrors('name')} ? 'invalid'" />
                                    <p class="field-hint field-hint-small">–°—ä–∑–¥–∞–π –∑–∞–ø–æ–º–Ω—è—â–æ —Å–µ –∑–∞–≥–ª–∞–≤–∏–µ.</p>
                                </div>

                                <div class="field">
                                    <div class="field-header">
                                        <label for="categoryId">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                                        <span class="badge-error" th:if="${#fields.hasErrors('categoryId')}" th:errors="*{categoryId}">–ò–∑–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                                    </div>
                                    <select id="categoryId" th:field="*{categoryId}" th:classappend="${#fields.hasErrors('categoryId')} ? 'invalid'">
                                        <option value="" disabled th:selected="${eventCreateRequest.categoryId} == null">–ò–∑–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è</option>
                                        <option th:each="category : ${categories}"
                                                th:value="${category.id}"
                                                th:text="${category.name}"></option>
                                    </select>
                                </div>

                                <div class="field">
                                    <div class="field-header">
                                        <label for="capacity">–ö–∞–ø–∞—Ü–∏—Ç–µ—Ç (–ø–æ –∏–∑–±–æ—Ä)</label>
                                        <span class="badge-error" th:if="${#fields.hasErrors('capacity')}" th:errors="*{capacity}">–í—ä–≤–µ–¥–∏ –∫–∞–ø–∞—Ü–∏—Ç–µ—Ç</span>
                                    </div>
                                    <input id="capacity" type="number" min="1" step="1" th:field="*{capacity}" placeholder="–û—Å—Ç–∞–≤–∏ –ø—Ä–∞–∑–Ω–æ –∑–∞ –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω" th:classappend="${#fields.hasErrors('capacity')} ? 'invalid'" />
                                </div>

                                <div class="field field-full-width">
                                    <div class="field-header">
                                        <label for="imageName">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                                    </div>
                                    <select id="imageName" th:field="*{imageName}">
                                        <option value="">–ë–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</option>
                                        <option th:each="image : ${availableImages}" 
                                                th:value="${image}" 
                                                th:text="${image}"></option>
                                    </select>
                                    <p class="field-hint field-hint-small">–ò–∑–±–µ—Ä–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞ —Å—ä–±–∏—Ç–∏–µ—Ç–æ.</p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 class="form-section-title">
                                <span>üìÑ</span>
                                <span>–û–ø–∏—Å–∞–Ω–∏–µ</span>
                            </h3>
                            <div class="field">
                                <div class="field-header">
                                    <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                                    <span class="badge-error" th:if="${#fields.hasErrors('description')}" th:errors="*{description}">–î–æ–±–∞–≤–∏ –æ–ø–∏—Å–∞–Ω–∏–µ</span>
                                </div>
                                <textarea id="description" rows="6" th:field="*{description}" placeholder="–†–∞–∑–∫–∞–∂–∏ –Ω–∞–∫—Ä–∞—Ç–∫–æ –∫–∞–∫–≤–æ –ø—Ä–µ–¥—Å—Ç–æ–∏, –∫–æ–∏ —Å–∞ –∞–∫—Ü–µ–Ω—Ç–∏—Ç–µ –∏ –∑–∞—â–æ –Ω–µ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–µ –ø—Ä–æ–ø—É—Å–∫–∞." class="textarea-resize" th:classappend="${#fields.hasErrors('description')} ? 'invalid'"></textarea>
                                <p class="field-hint field-hint-small">–°–ø–æ–¥–µ–ª–∏ –∫–ª—é—á–æ–≤–∏—Ç–µ –∞–∫—Ü–µ–Ω—Ç–∏, –≥–æ—Å—Ç-–ª–µ–∫—Ç–æ—Ä–∏—Ç–µ –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª–Ω–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.</p>
                            </div>
                        </div>

                        <div>
                            <h3 class="form-section-title">
                                <span>üìç</span>
                                <span>–õ–æ–∫–∞—Ü–∏—è</span>
                            </h3>
                            <div class="field">
                                <div class="field-header">
                                    <label for="location">–õ–æ–∫–∞—Ü–∏—è/–ú—è—Å—Ç–æ</label>
                                    <span class="badge-error" th:if="${#fields.hasErrors('location')}" th:errors="*{location}">–í—ä–≤–µ–¥–∏ –ª–æ–∫–∞—Ü–∏—è</span>
                                </div>
                                <input id="location" th:field="*{location}" placeholder="–¢—ä—Ä—Å–∏ –∞–¥—Ä–µ—Å –∏–ª–∏ –∫–ª–∏–∫–Ω–∏ –Ω–∞ –∫–∞—Ä—Ç–∞—Ç–∞" th:classappend="${#fields.hasErrors('location')} ? 'invalid'" />
                                <input type="hidden" id="latitude" name="latitude" th:field="*{latitude}" />
                                <input type="hidden" id="longitude" name="longitude" th:field="*{longitude}" />
                                <p class="field-hint field-hint-small">–¢—ä—Ä—Å–∏ –∞–¥—Ä–µ—Å –∏–ª–∏ –∫–ª–∏–∫–Ω–∏ –Ω–∞ –∫–∞—Ä—Ç–∞—Ç–∞, –∑–∞ –¥–∞ –∏–∑–±–µ—Ä–µ—à –ª–æ–∫–∞—Ü–∏—è.</p>
                            </div>
                            <div id="map" class="map-container"></div>
                        </div>

                        <div>
                            <h3 class="form-section-title">
                                <span>‚è±Ô∏è</span>
                                <span>–ì—Ä–∞—Ñ–∏–∫</span>
                            </h3>
                            <div class="form-grid-2">
                                <div class="field">
                                    <div class="field-header">
                                        <label for="startTime">–ù–∞—á–∞–ª–æ</label>
                                        <span class="badge-error" th:if="${#fields.hasErrors('startTime')}" th:errors="*{startTime}">–ù–∞—á–∞–ª–æ—Ç–æ –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ</span>
                                    </div>
                                    <input id="startTime" type="datetime-local" th:field="*{startTime}" th:classappend="${#fields.hasErrors('startTime')} ? 'invalid'" />
                                </div>

                                <div class="field">
                                    <div class="field-header">
                                        <label for="endTime">–ö—Ä–∞–π</label>
                                        <span class="badge-error" th:if="${#fields.hasErrors('endTime')}" th:errors="*{endTime}">–ö—Ä–∞—è—Ç –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–µ–Ω</span>
                                    </div>
                                    <input id="endTime" type="datetime-local" th:field="*{endTime}" th:classappend="${#fields.hasErrors('endTime')} ? 'invalid'" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-footer-custom">
                        <a class="btn btn-secondary btn-link" th:href="@{/home}">–û—Ç–∫–∞–∑</a>
                        <button type="submit" class="btn btn-primary btn-primary-custom">–°—ä–∑–¥–∞–π —Å—ä–±–∏—Ç–∏–µ</button>
                    </div>
                </form>
            </div>

            <div class="create-sidebar">
                <div class="card sidebar-card">
                    <div class="sidebar-header">
                        <span class="sidebar-icon">üí°</span>
                        <h3 class="sidebar-title">–ü–æ–ª–µ–∑–Ω–∏ —Å—ä–≤–µ—Ç–∏</h3>
                    </div>
                    <div class="sidebar-content">
                        <div>
                            <div class="sidebar-tip-title">üìù –ó–∞–≥–ª–∞–≤–∏–µ</div>
                            <p class="sidebar-tip-text">–°—ä–∑–¥–∞–π –∑–∞–ø–æ–º–Ω—è—â–æ —Å–µ –∏ —è—Å–Ω–æ –∑–∞–≥–ª–∞–≤–∏–µ, –∫–æ–µ—Ç–æ –∫–∞–∑–≤–∞ –Ω–∞ –∫–æ–≥–æ –µ —Å—ä–±–∏—Ç–∏–µ—Ç–æ.</p>
                        </div>
                        <div>
                            <div class="sidebar-tip-title">üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
                            <p class="sidebar-tip-text">–ò–∑–±–µ—Ä–∏ –ø–æ–¥—Ö–æ–¥—è—â–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –∑–∞ –¥–∞ –º–æ–≥–∞—Ç —É—á–∞—Å—Ç–Ω–∏—Ü–∏—Ç–µ –¥–∞ –æ—Ç–∫—Ä–∏—è—Ç —Å—ä–±–∏—Ç–∏–µ—Ç–æ –ø–æ-–ª–µ—Å–Ω–æ.</p>
                        </div>
                        <div>
                            <div class="sidebar-tip-title">üìÑ –û–ø–∏—Å–∞–Ω–∏–µ</div>
                            <p class="sidebar-tip-text">–û–ø–∏—à–∏ –∫–ª—é—á–æ–≤–∏—Ç–µ –∞–∫—Ü–µ–Ω—Ç–∏, –≥–æ—Å—Ç-–ª–µ–∫—Ç–æ—Ä–∏—Ç–µ –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª–Ω–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.</p>
                        </div>
                        <div>
                            <div class="sidebar-tip-title">‚è±Ô∏è –ì—Ä–∞—Ñ–∏–∫</div>
                            <p class="sidebar-tip-text">–û–ø—Ä–µ–¥–µ–ª–∏ –Ω–∞—á–∞–ª–æ –∏ –∫—Ä–∞–π, –∑–∞ –¥–∞ –º–æ–≥–∞—Ç –≥–æ—Å—Ç–∏—Ç–µ –¥–∞ –ø–ª–∞–Ω–∏—Ä–∞—Ç —É—á–∞—Å—Ç–∏–µ—Ç–æ —Å–∏.</p>
                        </div>
                        <div>
                            <div class="sidebar-tip-title">üë• –ö–∞–ø–∞—Ü–∏—Ç–µ—Ç</div>
                            <p class="sidebar-tip-text">–û—Å—Ç–∞–≤–∏ –ø—Ä–∞–∑–Ω–æ –∑–∞ –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω –∫–∞–ø–∞—Ü–∏—Ç–µ—Ç –∏–ª–∏ –∑–∞–¥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –±—Ä–æ–π –º–µ—Å—Ç–∞.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<th:block th:replace="~{fragments/footer :: siteFooter}"></th:block>

<script>
    let map;
    let marker;
    let searchTimeout;

    function initMap() {
        const locationInput = document.getElementById('location');
        const latitudeInput = document.getElementById('latitude');
        const longitudeInput = document.getElementById('longitude');
        
        const initialLat = latitudeInput.value ? parseFloat(latitudeInput.value) : 42.6977;
        const initialLng = longitudeInput.value ? parseFloat(longitudeInput.value) : 23.3219;

        map = L.map('map').setView([initialLat, initialLng], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        if (latitudeInput.value && longitudeInput.value) {
            marker = L.marker([initialLat, initialLng]).addTo(map);
            map.setView([initialLat, initialLng], 15);
        }

        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            if (marker) {
                marker.setLatLng([lat, lng]);
            } else {
                marker = L.marker([lat, lng]).addTo(map);
            }
            
            latitudeInput.value = lat;
            longitudeInput.value = lng;
            
            reverseGeocode(lat, lng, locationInput);
        });

        locationInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length < 3) return;
            
            searchTimeout = setTimeout(() => {
                geocode(query, locationInput, latitudeInput, longitudeInput);
            }, 500);
        });
    }

    function geocode(query, locationInput, latitudeInput, longitudeInput) {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&accept-language=bg`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lng = parseFloat(result.lon);
                    
                    if (marker) {
                        marker.setLatLng([lat, lng]);
                    } else {
                        marker = L.marker([lat, lng]).addTo(map);
                    }
                    
                    map.setView([lat, lng], 15);
                    latitudeInput.value = lat;
                    longitudeInput.value = lng;
                    locationInput.value = result.display_name;
                }
            })
            .catch(error => console.error('Geocoding error:', error));
    }

    function reverseGeocode(lat, lng, locationInput) {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=bg`)
            .then(response => response.json())
            .then(data => {
                if (data && data.display_name) {
                    locationInput.value = data.display_name;
                }
            })
            .catch(error => console.error('Reverse geocoding error:', error));
    }

    document.addEventListener('DOMContentLoaded', initMap);
</script>
</body>
</html>

